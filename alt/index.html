<!DOCTYPE html>
<html>
<head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div id="overlay"></div>
    <div id="settings">
        <button id="closeSettings">Close Settings</button> <br> <br>
        <label for="apiEndpoint">API Endpoint:</label><br>
        <input id="apiEndpoint" type="text" placeholder="OpenAI API endpoint"><br><br>
        <label for="apiKey">API Key:</label><br>
        <input id="apiKey" type="text" placeholder="Your OpenAI API Key"><br><br>
        <label for="systemRole">System Role:</label><br>
        <input id="systemRole" type="text" placeholder="Type system role content here..."><br><br>
        <label for="modelName">Model Name:</label><br>
        <input id="modelName" type="text" placeholder="Type model name here..."><br><br>
        <button id="saveSettingsButton">Save Changes</button>
    </div>
    <div id="chat">
        <div id="thinking">Assistant is thinking...</div>
    </div>
    <div id="buttonArea">
        <button id="settingsButton">Settings</button>
        <div class="div-spacer"></div>
        <button id="clearChat">Clear History</button>
        <div class="div-spacer"></div>
        <button id="copyLatest">Copy Latest Message</button>
    </div>
    <div id="inputArea">
        <textarea id="messageBox" rows="4" columns="50" placeholder="Type your message here... and press Shift+Enter to send"></textarea>
        <button id="sendButton">Send</button>
    </div>
    <script>
        let messages = [{
            "role": "system",
            "content": localStorage.getItem('systemRole') || "You are a helpful assistant."
        }];

        let apiEndpoint = localStorage.getItem('apiEndpoint');
        let apiKey = localStorage.getItem('apiKey');
        let modelName = localStorage.getItem('modelName') || 'gpt-3.5-turbo';

        if(apiEndpoint) $('#apiEndpoint').val(apiEndpoint);
        if(apiKey) $('#apiKey').val(apiKey);
        if(modelName) $('#modelName').val(modelName);

        $("#sendButton").click(sendMessage);
        $('#messageBox').keypress(function (e) {
            if (e.which == 13 && e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        $('#systemRole').val(messages[0].content);

        async function sendMessage() {
            const userContent = $("#messageBox").val().replace(/\n/g, '<br>');
            apiKey = $('#apiKey').val();
            apiEndpoint = $('#apiEndpoint').val();
            modelName = $('#modelName').val() || 'gpt-3.5-turbo';
            messages[0]["content"] = $('#systemRole').val();

            messages.push({
                "role": "user",
                "content": userContent
            });

            $('#chat').append('<div class="message"><strong>User:</strong><br> ' + userContent + '</div>');
            $("#thinking").show();

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        'model': modelName,
                        'messages': messages,
                        'stream': true
                    }),
                });

                // Read the response as a stream of data
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        break;
                    }
                    // Massage and parse the chunk of data
                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\\n");
                    const parsedLines = lines
                        .map((line) => line.replace(/^data: /, "").trim()) // Remove the "data: " prefix
                        .filter((line) => line !== "" && line !== "[DONE]") // Remove empty lines and "[DONE]"
                        .map((line) => JSON.parse(line)); // Parse the JSON string

                    for (const parsedLine of parsedLines) {
                        const { choices } = parsedLine;
                        const { delta } = choices[0];
                        const { content } = delta;
                        // Update the UI with the new content
                        if (content) {
                            let assistantReply = content.replace(/\n/g, '<br>');
                            messages.push({
                                "role": "assistant",
                                "content": assistantReply
                            });
                            $('#chat').append('<div class="message"><strong>Assistant:</strong><br> ' + assistantReply + '</div>');
                        }
                    }
                }

                $("#thinking").hide();
            } catch(err) {
                console.log(err);
            }

            $("#messageBox").val('');
        }

        $("#clearChat").click(function() {
            $("#chat").empty();
            messages = [{
                "role": "system",
                "content": localStorage.getItem('systemRole') || "You are a helpful assistant."
            }];
        });

        $("#copyLatest").click(function() {
            const latest = $('.message').last().text();
            const textarea = document.createElement('textarea');
            textarea.textContent = latest;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Latest message copied');
        });

        $("#settingsButton").click(function () {
            $('#settings').addClass('active');
            $('#overlay').addClass('active');
        });

        $("#closeSettings, #overlay").click(function () {
            $('#settings').removeClass('active');
            $('#overlay').removeClass('active');
        });

        $("#saveSettingsButton").click(function () {
            const apiKeyNew = $('#apiKey').val();
            const apiEndpointNew = $('#apiEndpoint').val();
            const systemRoleNew = $('#systemRole').val();
            const modelNameNew = $('#modelName').val();

            localStorage.setItem('apiEndpoint', apiEndpointNew);
            localStorage.setItem('apiKey', apiKeyNew);
            localStorage.setItem('systemRole', systemRoleNew);
            localStorage.setItem('modelName', modelNameNew || 'gpt-3.5-turbo');

            location.reload();
        });

    </script>
</body>
</html>
