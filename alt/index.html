<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        body {
            background-color: #111;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 95vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #settings {
            position: fixed;
            right: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: #222;
            padding: 20px;
            overflow: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            box-sizing: border-box;
            z-index: 2;
        }

        #settings.active {
            transform: translateX(0);
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
            display: none;
        }

        #overlay.active {
            display: block;
        }

        #chat, #buttonArea, #inputArea {
            z-index: 0;
        }

        #buttonArea {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px;
            border-bottom: 1px solid #eee;
            width: 500px;
        }

        #buttonArea .div-spacer {
            flex-grow: 1;
            border-right: 1px solid #eee;
            height: 20px;
            margin: 0 20px;
        }

        #inputArea {
            display: flex;
            margin-bottom: 10px;
        }

        #chat {
            width: 500px;
            height: 500px;
            overflow: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin: 20px 0;
            position: relative;
        }

        .message {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }

        #thinking {
            position: absolute;
            right: 5px;
            top: 5px;
            display: none;
        }

        textarea {
            resize: none;
        }

        input, button, textarea {
            margin: 5px 0;
        }

        input, textarea {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #eee;
        }

        label {
            margin-left: 5px;
            font-size: 0.9em;
            color: #eee;
        }

        button {
            padding: 5px 10px;
            border-radius: 3px;
            border: none;
            background-color: #333;
            color: #eee;
            cursor: pointer;
            margin: 5px 0;
        }

        button:hover {
            background-color: #444;
        }

    </style>
</head>
<body>
    <div id="overlay"></div>
    <div id="settings">
        <button id="closeSettings">Close Settings</button> <br> <br>
        <label for="apiEndpoint">API Endpoint:</label><br>
        <input id="apiEndpoint" type="text" placeholder="OpenAI API endpoint"><br><br>
        <label for="apiKey">API Key:</label><br>
        <input id="apiKey" type="text" placeholder="Your OpenAI API Key"><br><br>
        <label for="systemRole">System Role:</label><br>
        <input id="systemRole" type="text" placeholder="Type system role content here..."><br><br>
        <label for="modelName">Model Name:</label><br>
        <input id="modelName" type="text" placeholder="Type model name here..."><br><br>
        <button id="saveSettingsButton">Save Changes</button>
    </div>
    <div id="chat">
        <div id="thinking">Assistant is thinking...</div>
    </div>
    <div id="buttonArea">
        <button id="settingsButton">Settings</button>
        <div class="div-spacer"></div>
        <button id="clearChat">Clear History</button>
        <div class="div-spacer"></div>
        <button id="copyLatest">Copy Latest Message</button>
    </div>
    <div id="inputArea">
        <textarea id="messageBox" rows="4" columns="50" placeholder="Type your message here... and press Shift+Enter to send"></textarea>
        <button id="sendButton">Send</button>
    </div>
    <script>
        let messages = [{
            "role": "system",
            "content": localStorage.getItem('systemRole') || "You are a helpful assistant."
        }];

        let apiEndpoint = localStorage.getItem('apiEndpoint');
        let apiKey = localStorage.getItem('apiKey');
        let modelName = localStorage.getItem('modelName') || 'gpt-3.5-turbo';

        if(apiEndpoint) $('#apiEndpoint').val(apiEndpoint);
        if(apiKey) $('#apiKey').val(apiKey);
        if(modelName) $('#modelName').val(modelName);

        $("#sendButton").click(sendMessage);
        $('#messageBox').keypress(function (e) {
            if (e.which == 13 && e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        $('#systemRole').val(messages[0].content);

        async function sendMessage() {
function sendMessage() {
    const userContent = $("#messageBox").val().replace(/\n/g, '<br>');
    apiKey = $('#apiKey').val();
    apiEndpoint = $('#apiEndpoint').val();
    modelName = $('#modelName').val() || 'gpt-3.5-turbo';
    messages[0]["content"] = $('#systemRole').val();

    messages.push({
        "role": "user",
        "content": userContent
    });

    $('#chat').append('<div class="message"><strong>User:</strong><br> ' + userContent + '</div>');
    $("#thinking").show();

    fetch(apiEndpoint, {
      method: "POST",
      headers: {
         'Content-Type': 'application/json',
         'Authorization': 'Bearer ' + apiKey
      },
      body: JSON.stringify({
         'model': modelName,
         'messages': messages,
         'stream': true //For streaming responses 
       }),
    })
    .then(response => {
         const reader = response.body.getReader();
		 const decoder = new TextDecoder('utf-8');
				
		 reader.read().then(function processResult({ done, value }) {
	    	const chunk = decoder.decode(value);
	            const lines = chunk.split("\\n");
	            const parsedLines = lines
	                .map((line) => line.replace(/^data: /, "").trim()) 
	                .filter((line) => line !== "" && line !== "[DONE]") 
	                .map((line) => JSON.parse(line));

	            for (const parsedLine of parsedLines) {
	            	if(parsedLine.choices[0].delta.role != "system") {
	                	let assistantReply = parsedLine.choices[0].delta.content.replace(/\n/g, '<br>');
	                	messages.push({
	                    	"role": "assistant",
	                    	"content": assistantReply
	                	});
		                $('#chat').append('<div class="message"><strong>Assistant:</strong><br> ' + assistantReply + '</div>');
		              }
	            }
        
	           if (!done) {
                	return reader.read().then(processResult);
            	}
			
			   $("#thinking").hide();
		  });
    })
    .catch(error => {
      console.log(error);
    });
    
    $("#messageBox").val('');
}
        
        $("#clearChat").click(function() {
            $("#chat").empty();
            messages = [{
                "role": "system",
                "content": localStorage.getItem('systemRole') || "You are a helpful assistant."
            }];
        });

        $("#copyLatest").click(function() {
            const latest = $('.message').last().text();
            const textarea = document.createElement('textarea');
            textarea.textContent = latest;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Latest message copied');
        });

        $("#settingsButton").click(function () {
            $('#settings').addClass('active');
            $('#overlay').addClass('active');
        });

        $("#closeSettings, #overlay").click(function () {
            $('#settings').removeClass('active');
            $('#overlay').removeClass('active');
        });

        $("#saveSettingsButton").click(function () {
            const apiKeyNew = $('#apiKey').val();
            const apiEndpointNew = $('#apiEndpoint').val();
            const systemRoleNew = $('#systemRole').val();
            const modelNameNew = $('#modelName').val();

            localStorage.setItem('apiEndpoint', apiEndpointNew);
            localStorage.setItem('apiKey', apiKeyNew);
            localStorage.setItem('systemRole', systemRoleNew);
            localStorage.setItem('modelName', modelNameNew || 'gpt-3.5-turbo');

            location.reload();
        });

    </script>
</body>
</html>
